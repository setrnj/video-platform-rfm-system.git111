# 视频平台RFM分析系统架构

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    视频平台RFM分析系统                            │
│                  Video Platform RFM Analysis System            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据采集层     │    │   数据存储层     │    │   数据处理层     │
│  Data Ingestion │    │  Data Storage   │    │ Data Processing │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ • 原始数据上传   │    │ • Hadoop HDFS   │    │ • Hive SQL      │
│ • 数据格式转换   │    │ • Hive 数据仓库 │    │ • ETL 流程      │
│ • 数据质量检查   │    │ • 分区表设计    │    │ • 维度建模      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   分析计算层     │    │   可视化层       │    │   应用服务层     │
│ Analysis Layer  │    │ Visualization   │    │ Application     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ • RFM 分析      │    │ • 图表生成      │    │ • Web 界面      │
│ • 用户分群      │    │ • 报告输出      │    │ • API 接口      │
│ • 留存分析      │    │ • 仪表板        │    │ • 定时任务      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 数据流程架构

### 1. 数据采集流程
```
原始数据源 → 数据清洗 → 格式转换 → HDFS存储
    │           │         │         │
    ▼           ▼         ▼         ▼
媒体数据    数据验证    标准化    分区存储
用户数据    去重处理    编码转换    ORC格式
行为数据    异常检测    类型转换   压缩存储
```

### 2. ETL处理流程
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 原始数据表   │───▶│ 数据清洗    │───▶│ 维度表加载   │
│ Raw Tables  │    │ Data Clean  │    │ Dimension   │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                    │
                           ▼                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 事实表加载   │◀───│ 数据关联    │◀───│ 时间维度     │
│ Fact Tables │    │ Data Join   │    │ Time Dim    │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 3. 分析计算流程
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ RFM 计算    │───▶│ 用户分群    │───▶│ 聚类分析     │
│ RFM Calc    │    │ Segmentation│    │ Clustering  │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                    │
                           ▼                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 留存分析    │    │ 时段分析    │    │ 可视化生成   │
│ Retention   │    │ Time Analysis│    │ Visualization│
└─────────────┘    └─────────────┘    └─────────────┘
```

## 技术架构

### 1. 存储层架构
```
┌─────────────────────────────────────────────────────────────┐
│                       存储层 (Storage Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  Hadoop HDFS (分布式文件系统)                                │
│  ├── /data/video_analysis/raw/     (原始数据)                │
│  ├── /data/video_analysis/cleaned/ (清洗数据)                │
│  └── /data/video_analysis/dwh/     (数据仓库)                │
│                                                             │
│  Hive 数据仓库 (结构化数据存储)                               │
│  ├── raw_media (原始媒体表)                                  │
│  ├── raw_users (原始用户表)                                  │
│  ├── dim_user (用户维度表)                                   │
│  ├── dim_time (时间维度表)                                   │
│  └── fact_watching (观看事实表)                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. 计算层架构
```
┌─────────────────────────────────────────────────────────────┐
│                       计算层 (Compute Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  Hive SQL Engine (SQL计算引擎)                               │
│  ├── 数据清洗 SQL                                            │
│  ├── 维度建模 SQL                                            │
│  ├── 事实表加载 SQL                                          │
│  └── 分析查询 SQL                                            │
│                                                             │
│  Python 分析引擎 (机器学习)                                  │
│  ├── RFM 分析计算                                           │
│  ├── K-means 聚类                                           │
│  ├── 用户分群算法                                           │
│  └── 统计分析计算                                           │
└─────────────────────────────────────────────────────────────┘
```

### 3. 应用层架构
```
┌─────────────────────────────────────────────────────────────┐
│                       应用层 (Application Layer)              │
├─────────────────────────────────────────────────────────────┤
│  主程序入口 (main.py)                                        │
│  ├── ETL 流程控制                                           │
│  ├── RFM 分析控制                                           │
│  ├── 可视化控制                                             │
│  └── 配置管理                                               │
│                                                             │
│  模块化组件                                                 │
│  ├── src/data_generation/    (数据生成)                     │
│  ├── src/rfm_analysis/       (RFM分析)                      │
│  ├── src/clustering/         (聚类分析)                     │
│  └── src/visualization/      (可视化)                       │
└─────────────────────────────────────────────────────────────┘
```

## 数据模型设计

### 1. 维度表设计
```
┌─────────────────┐    ┌─────────────────┐
│   用户维度表     │    │   时间维度表     │
│   dim_user      │    │   dim_time      │
├─────────────────┤    ├─────────────────┤
│ user_key (PK)   │    │ time_key (PK)   │
│ phone_no        │    │ full_time       │
│ user_level      │    │ hour_of_day     │
│ device_type     │    │ day_of_week     │
│ region          │    │ month           │
└─────────────────┘    └─────────────────┘
```

### 2. 事实表设计
```
┌─────────────────────────────────────────┐
│              观看事实表                  │
│            fact_watching                │
├─────────────────────────────────────────┤
│ user_key (FK) → dim_user.user_key       │
│ time_key (FK) → dim_time.time_key       │
│ channel_key (FK) → dim_channel.ch_key   │
│ duration_min (度量值)                   │
│ dt (分区字段)                           │
└─────────────────────────────────────────┘
```

## 性能优化架构

### 1. 存储优化
```
┌─────────────────────────────────────────────────────────────┐
│                       存储优化策略                            │
├─────────────────────────────────────────────────────────────┤
│  分区策略: 按日期分区 (dt='2024-01-01')                      │
│  存储格式: ORC (列式存储，高压缩比)                           │
│  压缩算法: Snappy (快速压缩)                                │
│  分桶策略: 按用户ID分桶 (提高JOIN性能)                       │
└─────────────────────────────────────────────────────────────┘
```

### 2. 计算优化
```
┌─────────────────────────────────────────────────────────────┐
│                       计算优化策略                            │
├─────────────────────────────────────────────────────────────┤
│  向量化执行: hive.vectorized.execution.enabled=true          │
│  并行执行: hive.exec.parallel=true                          │
│  CBO优化: hive.cbo.enable=true                               │
│  内存优化: 合理设置HADOOP_HEAPSIZE和HIVE_HEAPSIZE            │
└─────────────────────────────────────────────────────────────┘
```

## 监控和运维架构

### 1. 日志监控
```
┌─────────────────────────────────────────────────────────────┐
│                       监控体系                               │
├─────────────────────────────────────────────────────────────┤
│  应用日志: logs/etl.log, logs/system.log                    │
│  系统监控: HDFS使用率, Hive查询性能                         │
│  业务监控: 数据质量, 分析结果准确性                         │
│  告警机制: 邮件通知, 短信告警                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. 部署架构
```
┌─────────────────────────────────────────────────────────────┐
│                       部署架构                               │
├─────────────────────────────────────────────────────────────┤
│  开发环境: 单节点部署，用于功能测试                          │
│  测试环境: 小规模集群，用于性能测试                          │
│  生产环境: 高可用集群，支持大规模数据处理                    │
│  容器化: Docker容器部署，支持快速扩展                       │
└─────────────────────────────────────────────────────────────┘
```

## 扩展性设计

### 1. 水平扩展
- **HDFS集群**: 支持多节点扩展
- **Hive集群**: 支持多HiveServer2实例
- **计算资源**: 支持动态资源分配

### 2. 功能扩展
- **新数据源**: 支持更多数据源接入
- **新分析算法**: 支持更多机器学习算法
- **新可视化**: 支持更多图表类型

### 3. 性能扩展
- **缓存机制**: Redis缓存热点数据
- **预计算**: 预计算常用分析结果
- **增量处理**: 支持增量数据更新
